C51 COMPILER V9.52.0.0   MAIN                                                              04/03/2025 13:05:16 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\por-tool\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "main.h"
   2          #include "driver.h"
   3          #include "iic.h"
   4          #include <stdio.h>
   5          /*LED 参数*/
   6          u8 LED_DP=0;
   7          u8 FLAG_LED=1;
   8          /*ISR 参数*/
   9          u32 T1_1MS=0;
  10          /*SEG 参数*/
  11          u8 SEG_DP[10]="1234",
  12            SEG_CD[8]={0},
  13            SEG_Pos=0;
  14          u8 FLAG_SEG=0;
  15          u8 page=0;
  16          /*Freq 参数*/
  17          u16 FREQ=0,FREQ_SAVE=0;
  18          /*ADC 参数*/
  19          u8 FLAG_ADC=0;
  20          u8 chnal=1;
  21          u16 LIGHT=0;//x100
  22          u16 RB2=0,RB2_SAVE;//x100
  23            
  24          void SEG_Fuc(void);
  25          void KEY_Fuc(void);
  26          void ADC_Fuc(void);
  27          void LED_Fuc(void);
  28            
  29          void main(void){
  30   1        DEV_Cls();
  31   1        T1_Int();
  32   1        T0_Int();
  33   1        while(1)
  34   1        {
  35   2          KEY_Fuc();
  36   2          ADC_Fuc();
  37   2          SEG_Fuc();
  38   2          LED_Fuc();
  39   2        }
  40   1      }
  41          void SEG_Fuc(void){
  42   1        if(FLAG_SEG){
  43   2          FLAG_SEG=0;
  44   2          switch(page)
  45   2          {
  46   3            case 0:
  47   3              sprintf(SEG_DP,"F%7u",FREQ);
  48   3              break;
  49   3            case 1:
  50   3              sprintf(SEG_DP,"N%7u",1000000/FREQ);
  51   3              break;
  52   3            case 2:
  53   3              if(chnal==1){
  54   4              sprintf(SEG_DP,"U-%1d``%3.2f",chnal,LIGHT/100.0);
  55   4              }
C51 COMPILER V9.52.0.0   MAIN                                                              04/03/2025 13:05:16 PAGE 2   

  56   3              else if(chnal==3){
  57   4              sprintf(SEG_DP,"U-%1d``%3.2f",chnal,RB2/100.0);
  58   4              }
  59   3              break;      
  60   3          }
  61   2          SEG_Tran(SEG_DP,SEG_CD);
  62   2      }
  63   1      }
  64          void KEY_Fuc(void){
  65   1        static u32 keyT=0;
  66   1        static u8 keyPast=0;
  67   1        static u8 flagKey7=0;
  68   1        u8 keyNow=0;
  69   1        keyNow=KEY_Independ();
  70   1        if(keyPast!=keyNow){
  71   2          keyT=T1_1MS;
  72   2          switch(keyNow)
  73   2          {
  74   3            case 0:
  75   3              if(flagKey7)
  76   3              {
  77   4                FLAG_LED=!FLAG_LED;
  78   4              }
  79   3              break;
  80   3            case 4:
  81   3              page=(++page)%3;
  82   3              break;
  83   3            case 5:
  84   3              chnal=(chnal+2)&0x03;
  85   3              break;
  86   3            case 6:
  87   3              RB2_SAVE=RB2;
  88   3              break;
  89   3            case 7:
  90   3              FREQ_SAVE=FREQ;
  91   3              break;
  92   3          }
  93   2          keyPast=keyNow;
  94   2        }
  95   1        if(T1_1MS-keyT>=1000){
  96   2          if(keyNow==7){
  97   3            flagKey7=1;
  98   3        }
  99   2        }
 100   1      }
 101          void ADC_Fuc(void){
 102   1          u8 ADCget;
 103   1          float fADC=0;
 104   1          if(FLAG_ADC){
 105   2          FLAG_ADC=0;
 106   2          ADCget=PCF8591_ADC(chnal);
 107   2          if(chnal%3)
 108   2          {
 109   3            LIGHT=(ADCget*5.0/255+0.005)*100;
 110   3          }
 111   2          else
 112   2          {
 113   3            RB2=(ADCget*5.0/255+0.005)*100;
 114   3          }
 115   2      }
 116   1      }
 117          void LED_Fuc(void){
C51 COMPILER V9.52.0.0   MAIN                                                              04/03/2025 13:05:16 PAGE 3   

 118   1        static u8 led_past=0;
 119   1        if(FLAG_LED){
 120   2          //L3,L4,L5
 121   2          LED_DP|=(1<<2+page);
 122   2          LED_DP&=(~(1<<2+page))|0x03;
 123   2          //L1
 124   2          if(RB2>RB2_SAVE)
 125   2          {
 126   3            LED_DP|=(u8)1;
 127   3          }else
 128   2          {
 129   3            LED_DP&=(u8)~1;
 130   3          }
 131   2          //L2
 132   2          if(FREQ>FREQ_SAVE)
 133   2          {
 134   3            LED_DP|=(u8)(1<<1);
 135   3          }else
 136   2          {
 137   3            LED_DP&=(u8)~(1<<1);
 138   3          }
 139   2          if(led_past!=LED_DP)
 140   2          {
 141   3            led_past=LED_DP;
 142   3            LED_Disp(LED_DP);
 143   3          }
 144   2      }
 145   1      }
 146          
 147          void T1_ISR(void) interrupt 3
 148          {
 149   1        static T1_100MS=0,T1_1S=0;
 150   1        T1_1MS++;
 151   1        if(++T1_100MS==10){
 152   2          T1_100MS=0;
 153   2          FLAG_SEG=1;
 154   2          FLAG_ADC=1;
 155   2      }
 156   1        if(++T1_1S==1000){
 157   2          T1_1S=0;
 158   2          FREQ=(u16)(TH0<<8)+TL0;
 159   2          TR0=0;
 160   2          TH0=0x00;
 161   2          TL0=0x00;
 162   2          TR0=1;
 163   2      }
 164   1        SEG_Disp(SEG_CD,SEG_Pos);
 165   1        SEG_Pos=(++SEG_Pos)&0x07;
 166   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    758    ----
   CONSTANT SIZE    =     23    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     50       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
