C51 COMPILER V9.52.0.0   IIC                                                               04/01/2025 15:32:09 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN iic.OBJ
COMPILER INVOKED BY: D:\por-tool\Keil\C51\BIN\C51.EXE iic.c LARGE BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*  #   I2C代码片段说明
   2              1.  本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
   3              2.  参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型
             -运行速度和试题
   4                  中对单片机时钟频率的要求，进行代码调试和修改。
   5          */
   6          
   7          #define DELAY_TIME 5
   8          #include "iic.h"
   9          // 延时
  10          static void I2C_Delay(unsigned char n)
  11          {
  12   1          do
  13   1          {
  14   2              _nop_();
  15   2              _nop_();
  16   2              _nop_();
  17   2              _nop_();
  18   2              _nop_();
  19   2              _nop_();
  20   2              _nop_();
  21   2              _nop_();
  22   2              _nop_();
  23   2              _nop_();
  24   2              _nop_();
  25   2              _nop_();
  26   2              _nop_();
  27   2              _nop_();
  28   2              _nop_();
  29   2          } while (n--);
  30   1      }
  31          
  32          // 启动通讯
  33          void I2CStart(void)
  34          {
  35   1          sda = 1;
  36   1          scl = 1;
  37   1          I2C_Delay(DELAY_TIME);
  38   1          sda = 0;
  39   1          I2C_Delay(DELAY_TIME);
  40   1          scl = 0;
  41   1      }
  42          
  43          // 停止通讯
  44          void I2CStop(void)
  45          {
  46   1          sda = 0;
  47   1          scl = 1;
  48   1          I2C_Delay(DELAY_TIME);
  49   1          sda = 1;
  50   1          I2C_Delay(DELAY_TIME);
  51   1      }
  52          
  53          // 发送字节
  54          void I2CSendByte(unsigned char byt)
C51 COMPILER V9.52.0.0   IIC                                                               04/01/2025 15:32:09 PAGE 2   

  55          {
  56   1          unsigned char i;
  57   1      
  58   1          for (i = 0; i < 8; i++)
  59   1          {
  60   2              scl = 0;
  61   2              I2C_Delay(DELAY_TIME);
  62   2              if (byt & 0x80)
  63   2              {
  64   3                  sda = 1;
  65   3              }
  66   2              else
  67   2              {
  68   3                  sda = 0;
  69   3              }
  70   2              I2C_Delay(DELAY_TIME);
  71   2              scl = 1;
  72   2              byt <<= 1;
  73   2              I2C_Delay(DELAY_TIME);
  74   2          }
  75   1      
  76   1          scl = 0;
  77   1      }
  78          
  79          // 接受数据
  80          unsigned char I2CReceiveByte(void)
  81          {
  82   1          unsigned char da;
  83   1          unsigned char i;
  84   1          for (i = 0; i < 8; i++)
  85   1          {
  86   2              scl = 1;
  87   2              I2C_Delay(DELAY_TIME);
  88   2              da <<= 1;
  89   2              if (sda)
  90   2                  da |= 0x01;
  91   2              scl = 0;
  92   2              I2C_Delay(DELAY_TIME);
  93   2          }
  94   1          return da;
  95   1      }
  96          
  97          // 等待应答
  98          unsigned char I2CWaitAck(void)
  99          {
 100   1          unsigned char ackbit;
 101   1      
 102   1          scl = 1;
 103   1          I2C_Delay(DELAY_TIME);
 104   1          ackbit = sda;
 105   1          scl = 0;
 106   1          I2C_Delay(DELAY_TIME);
 107   1      
 108   1          return ackbit;
 109   1      }
 110          
 111          // 发送应答
 112          void I2CSendAck(unsigned char ackbit)
 113          {
 114   1          scl = 0;
 115   1          sda = ackbit;
 116   1          I2C_Delay(DELAY_TIME);
C51 COMPILER V9.52.0.0   IIC                                                               04/01/2025 15:32:09 PAGE 3   

 117   1          scl = 1;
 118   1          I2C_Delay(DELAY_TIME);
 119   1          scl = 0;
 120   1          sda = 1;
 121   1          I2C_Delay(DELAY_TIME);
 122   1      }
 123          
 124          /*user code here*/
 125          unsigned char PCF8591_ADC(u8 chanl)
 126          {
 127   1          u8 tADC;
 128   1          I2CStart();
 129   1          I2CSendByte(0x90);
 130   1          I2CWaitAck();
 131   1          I2CSendByte(0x40|chanl);
 132   1          I2CWaitAck();
 133   1      
 134   1          I2CStart();
 135   1          I2CSendByte(0x91);
 136   1          I2CWaitAck();
 137   1          tADC = I2CReceiveByte();
 138   1          I2CSendAck(0);
 139   1          tADC = I2CReceiveByte();
 140   1          I2CSendAck(1);
 141   1          I2CStop();
 142   1          return tADC;
 143   1      }
 144          void PCF8591_DAC(u8 DACp)
 145          {
 146   1          I2CStart();
 147   1          I2CSendByte(0x90);
 148   1          I2CWaitAck();
 149   1          I2CSendByte(0x43);
 150   1          I2CWaitAck();
 151   1          I2CSendByte(DACp);
 152   1          I2CWaitAck();
 153   1          I2CStop();
 154   1      }
 155          void EE_WR(u8 *pData, u8 add, u8 n)
 156          {
 157   1          I2CStart();
 158   1          I2CSendByte(0xA0);
 159   1          I2CWaitAck();
 160   1          I2CSendByte(add);
 161   1          I2CWaitAck();
 162   1          while (n--)
 163   1          {
 164   2              I2CSendByte(*(pData++));
 165   2              I2CWaitAck();
 166   2          }
 167   1          I2CStop();
 168   1      }
 169          void EE_RD(u8 *pData, u8 add, u8 n)
 170          {
 171   1          I2CStart();
 172   1          I2CSendByte(0xA0);
 173   1          I2CWaitAck();
 174   1          I2CSendByte(add);
 175   1          I2CWaitAck();
 176   1          I2CStart();
 177   1          I2CSendByte(0xA1);
 178   1          I2CWaitAck();
C51 COMPILER V9.52.0.0   IIC                                                               04/01/2025 15:32:09 PAGE 4   

 179   1          while (n--)
 180   1          {
 181   2              *pData++ = I2CReceiveByte();
 182   2              if (n)
 183   2              {
 184   3                  I2CSendAck(0);
 185   3              }
 186   2              else
 187   2              {
 188   3                  I2CSendAck(1);
 189   3              }
 190   2          }
 191   1          I2CStop();
 192   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    396    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      10
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
