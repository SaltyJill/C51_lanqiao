C51 COMPILER V9.52.0.0   MAIN                                                              03/17/2025 19:07:52 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\por-tool\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "main.h"
   2          #include "tim.h"
   3          
   4          #include "iic.h"
   5          
   6          #include <stdio.h>
   7          #include <string.h>
   8          #include <math.h>
   9          
  10          #define somenops \
  11              {            \
  12                  _nop_(); \
  13                  _nop_(); \
  14                  _nop_(); \
  15                  _nop_(); \
  16                  _nop_(); \
  17                  _nop_(); \
  18                  _nop_(); \
  19                  _nop_(); \
  20                  _nop_(); \
  21                  _nop_(); \
  22                  _nop_(); \
  23                  _nop_(); \
  24                  _nop_(); \
  25                  _nop_(); \
  26                  _nop_(); \
  27              }
  28          
  29          // #define 15nops {_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_()
             -;_nop_();_nop_();_nop_();_nop_();}
  30          
  31          u8 ucLed = 0;
  32          // volatile u8 ucMode=0;
  33          u8 ucMode = 0;
  34          u8 ucAdc_Cnt = 0, ucAdc_Flag = 0;
  35          
  36          u32 uwMs = 0;
  37          u32 uwMs10 = 0;
  38          u16 usSec = 0;
  39          u8 pucSeg_Buff[10] = "12345678", pucSeg_Code[8] = {0}, ucSeg_Pos = 0;
  40          
  41          // u8 ucAdc=0;    //debug
  42          // float fAdc;    //debug
  43          u16 uiAdc;
  44          s16 siPar;
  45          u8 ucNum = 0;
  46          
  47          u8 ucKey_Num = 0; // debug
  48          u8 ucL3_ON = 0;
  49          u8 ucL1_Flag = 0; // Adc<Para
  50          u32 uwL1_Time = 0;
  51          void Key_Proc(void);
  52          void Seg_Proc(void);
  53          void Adc_Proc(void);
  54          void Led_Proc(void);
C51 COMPILER V9.52.0.0   MAIN                                                              03/17/2025 19:07:52 PAGE 2   

  55          
  56          void main(void)
  57          {
  58   1          u8 ucMem;
  59   1          Cls_Waishe();
  60   1          T1_Init();
  61   1      
  62   1          EE_Read(&ucMem, 0, 1);
  63   1          if (ucMem > 50)
  64   1              ucMem = 0;
  65   1          siPar = ucMem * 10;
  66   1      
  67   1          while (1)
  68   1          {
  69   2              Key_Proc();
  70   2              Seg_Proc();
  71   2              Adc_Proc();
  72   2              Led_Proc();
  73   2          }
  74   1      }
  75          void Key_Proc(void)
  76          {
  77   1          static u32 Key_10ms_temp = 0;
  78   1          u8 ucMem;
  79   1          static u8 ucKey_Old = 0;
  80   1          u8 ucKey_Now;
  81   1          u8 Key_time;
  82   1          // static u8 ucKey_Num=0;
  83   1          // ucKey_Now=KBD_Read();
  84   1          ucKey_Now = KBD_Read();
  85   1          //if (Key_10ms_temp != uwMs10)
  86   1              //Key_10ms_temp=uwMs10;
  87   1              if (ucKey_Now != ucKey_Old)
  88   1              {
  89   2                  Key_time = uwMs;
  90   2                  switch (ucKey_Now)
  91   2                  {
  92   3                  case 0:
  93   3                      break;
  94   3                  case 9:                      // S12
  95   3                      ucMode = (++ucMode) % 3; // ucMode++
  96   3                      if (ucMode == 2)
  97   3                      {
  98   4                          ucMem = siPar / 10;
  99   4                          EE_Write(&ucMem, 0, 1);
 100   4                      }
 101   3                      ucKey_Num = 0;
 102   3                      ucL3_ON = 0;
 103   3                      break;
 104   3                  case 10: // S13
 105   3                      if (ucMode == 2)
 106   3                      {
 107   4                          ucNum = 0;
 108   4                          ucKey_Num = 0;
 109   4                          ucL3_ON = 0;
 110   4                      }
 111   3                      else
 112   3                      {
 113   4                          ucKey_Num++;
 114   4                          if (ucKey_Num >= 3)
 115   4                          {
 116   5                              ucL3_ON = 1;
C51 COMPILER V9.52.0.0   MAIN                                                              03/17/2025 19:07:52 PAGE 3   

 117   5                          }
 118   4                      }
 119   3      
 120   3                      break;
 121   3                  case 13: // S16
 122   3                      if (ucMode == 1)
 123   3                      {
 124   4                          siPar += 50;
 125   4                          if (siPar > 500)
 126   4                              siPar = 0;
 127   4                          ucKey_Num = 0;
 128   4                          ucL3_ON = 0;
 129   4                      }
 130   3                      else
 131   3                      {
 132   4                          ucKey_Num++;
 133   4                          if (ucKey_Num >= 3)
 134   4                          {
 135   5                              ucL3_ON = 1;
 136   5                          }
 137   4                      }
 138   3                      break;
 139   3                  case 14: // S17
 140   3                      if (ucMode == 1)
 141   3                      {
 142   4                          siPar -= 50;
 143   4                          if (siPar < 0)
 144   4                              siPar = 500;
 145   4                          ucKey_Num = 0;
 146   4                          ucL3_ON = 0;
 147   4                      }
 148   3                      else
 149   3                      {
 150   4                          ucKey_Num++;
 151   4                          if (ucKey_Num >= 3)
 152   4                          {
 153   5                              ucL3_ON = 1;
 154   5                          }
 155   4                      }
 156   3                      break;
 157   3                  default:
 158   3                      break;
 159   3                  }
 160   2                  ucKey_Old = ucKey_Now;
 161   2              }
 162   1              //if ((uwMs - Key_time) > 2000)
 163   1              //{
 164   1                  //switch (ucKey_Old)
 165   1                  //{
 166   1                  //case 13: // S16
 167   1                      //if (ucMode == 1)
 168   1                      //{
 169   1                        //  siPar += 50;
 170   1                         // if (siPar > 500)
 171   1                         //     siPar = 0;
 172   1                          //ucKey_Num = 0;
 173   1                          //ucL3_ON = 0;
 174   1                      //}
 175   1                      //break;
 176   1                  //case 14: // S17
 177   1                    //  if (ucMode == 1)
 178   1                      //{
C51 COMPILER V9.52.0.0   MAIN                                                              03/17/2025 19:07:52 PAGE 4   

 179   1                        //  siPar -= 50;
 180   1                          //if (siPar < 0)
 181   1                            //  siPar = 500;
 182   1                          //ucKey_Num = 0;
 183   1                          //ucL3_ON = 0;
 184   1                      //}
 185   1                      //break;
 186   1                  //}
 187   1             // }
 188   1      }
*** WARNING C280 IN LINE 77 OF main.c: 'Key_10ms_temp': unreferenced local variable
 189          
 190          void Seg_Proc(void)
 191          {
 192   1          static u32 uwMs10Temp = 0;
 193   1          /*   method 2/3
 194   1          if(!ucSeg_Flag) return;
 195   1          ucSeg_Flag=0;*/
 196   1          if (uwMs10Temp != uwMs10) // method 3
 197   1          {
 198   2              uwMs10Temp = uwMs10;
 199   2              if (!ucMode)
 200   2              {
 201   3                  sprintf(pucSeg_Buff, "U    %4.2f", uiAdc / 100.0);
 202   3                  // sprintf(pucSeg_Buff, "U%2u%2u%4.2f",(u16)ucKey_Num,(u16)ucL3_ON, (float)(uiAdc/100.0));
 203   3                  // sprintf(pucSeg_Buff, "U%2u%2u", (u16)ucKey_Num,(u16)ucL3_ON);
 204   3                  // sprintf(pucSeg_Buff, "%.3f%3u", fAdc,(u16)uiAdc);
 205   3              }
 206   2              else if (ucMode == 1)
 207   2              {
 208   3                  sprintf(pucSeg_Buff, "P    %4.2f", siPar / 100.0);
 209   3              }
 210   2              else
 211   2              {
 212   3                  sprintf(pucSeg_Buff, "N     %2u", (u16)ucNum);
 213   3              }
 214   2              // sprintf(pucSeg_Buff, "U    %3d", (u16)ucMode);
 215   2              Seg_Tran(pucSeg_Buff, pucSeg_Code);
 216   2          }
 217   1      }
 218          void ISR_T1() interrupt 3 // 1ms
 219          {
 220   1          static u8 ucMsCnt = 0;
 221   1          uwMs++;
 222   1          /* method 1
 223   1          if(++ucSeg_Cnt==10)   //
 224   1          {
 225   1              ucSeg_Cnt=0;
 226   1              ucSeg_Flag=1;
 227   1          }*/
 228   1          /* method 2
 229   1          if(ulMs % 10==0)
 230   1              ucSeg_Flag=1;*/
 231   1          if (uwMs % 10 == 0) // method 3
 232   1              uwMs10++;
 233   1      
 234   1          if (++ucAdc_Cnt == 100)
 235   1          {
 236   2              ucAdc_Cnt = 0;
 237   2              ucAdc_Flag = 1;
 238   2          }
 239   1      
C51 COMPILER V9.52.0.0   MAIN                                                              03/17/2025 19:07:52 PAGE 5   

 240   1          // PWM  target:1
 241   1          /* P34 ^=1; */
 242   1          // PWM  target:2
 243   1          /*
 244   1          if(++ucMsCnt==5)
 245   1          {
 246   1              ucMsCnt=0;
 247   1              P34 ^=1;
 248   1          }*/
 249   1          // PWM  target:3
 250   1          /*
 251   1          if(++ucMsCnt==10) ucMsCnt=0;
 252   1          if(!ucMsCnt)
 253   1              P34=1;
 254   1          else if(ucMsCnt==3)
 255   1              P34=0;
 256   1          */
 257   1          if (uwMs % 1000 == 0)
 258   1          {
 259   2              usSec++;
 260   2          }
 261   1          Seg_Disp(pucSeg_Code, ucSeg_Pos);
 262   1          if (++ucSeg_Pos == 8)
 263   1              ucSeg_Pos = 0;
 264   1      }
*** WARNING C280 IN LINE 220 OF main.c: 'ucMsCnt': unreferenced local variable
 265          void Adc_Proc(void)
 266          {
 267   1          u8 ucAdc;
 268   1          float fAdc;
 269   1          static u16 uiAdc_Old = 0;
 270   1          if (!ucAdc_Flag)
 271   1              return;
 272   1          ucAdc_Flag = 0;
 273   1      
 274   1          ucAdc = PCF8591_Adc();
 275   1          // if(ucAdc==0) ucAdc=199;
 276   1          fAdc = ucAdc * 5.0 / 255;
 277   1          uiAdc = fAdc * 100 + 0.5; // 自定义四舍五入
 278   1          if (uiAdc_Old > siPar && uiAdc <= siPar)
 279   1              ucNum++;
 280   1          if (uiAdc_Old >= siPar && uiAdc < siPar)
 281   1          {
 282   2              ucL1_Flag = 1;
 283   2              uwL1_Time = uwMs;
 284   2          }
 285   1          if (uiAdc >= siPar)
 286   1              ucL1_Flag = 0;
 287   1          uiAdc_Old = uiAdc;
 288   1      }
 289          void Led_Proc(void)
 290          {
 291   1          static u32 uwMs10Temp = 0;
 292   1          if (uwMs10Temp != uwMs10) // method 3
 293   1          {
 294   2              uwMs10Temp = uwMs10;
 295   2              if (ucL1_Flag && (uwMs - uwL1_Time) >= 5000)
 296   2                  ucLed |= 1;
 297   2              else
 298   2                  ucLed &= ~1;
 299   2              if (ucNum % 2)
 300   2                  ucLed |= 1 << 1;
C51 COMPILER V9.52.0.0   MAIN                                                              03/17/2025 19:07:52 PAGE 6   

 301   2              else
 302   2                  ucLed &= ~(1 << 1);
 303   2              if (ucL3_ON)
 304   2                  ucLed |= 1 << 2;
 305   2              else
 306   2                  ucLed &= ~(1 << 2);
 307   2              Led_Disp(ucLed);
 308   2          }
 309   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    907    ----
   CONSTANT SIZE    =     32    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     61       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
